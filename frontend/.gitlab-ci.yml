stages:
  - install
  - lint
  - test
  - build

variables:
  NODE_VERSION: "20"

cache:
  key:
    files:
      - package-lock.json
  paths:
    - .npm/
    - node_modules/

install:dependencies:
  stage: install
  image: node:${NODE_VERSION}-alpine
  script:
    - npm ci --prefer-offline --no-audit
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

lint:eslint:
  stage: lint
  image: node:${NODE_VERSION}-alpine
  dependencies:
    - install:dependencies
  script:
    - npm run lint || echo "Linting not configured"
  allow_failure: true

test:unit:
  stage: test
  image: node:${NODE_VERSION}-alpine
  dependencies:
    - install:dependencies
  script:
    - npm run test || echo "Tests not configured"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    expire_in: 1 week
  allow_failure: true

build:production:
  stage: build
  image: node:${NODE_VERSION}-alpine
  dependencies:
    - install:dependencies
  script:
    - npm run build
  artifacts:
    paths:
      - .output/
      - .nuxt/
    expire_in: 1 week
  only:
    - master
    - main
    - production

