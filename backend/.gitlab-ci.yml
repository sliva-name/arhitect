stages:
  - install
  - lint
  - analyze
  - test
  - build

variables:
  PHP_VERSION: "8.3"
  COMPOSER_CACHE_DIR: "$CI_PROJECT_DIR/.composer-cache"

cache:
  key:
    files:
      - composer.lock
  paths:
    - .composer-cache/
    - vendor/

install:dependencies:
  stage: install
  image: composer:latest
  script:
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
  artifacts:
    paths:
      - vendor/
    expire_in: 1 hour

lint:pint:
  stage: lint
  image: php:${PHP_VERSION}
  dependencies:
    - install:dependencies
  before_script:
    - docker-php-ext-install zip
  script:
    - ./vendor/bin/pint --test
  allow_failure: false

analyze:phpstan:
  stage: analyze
  image: php:${PHP_VERSION}
  dependencies:
    - install:dependencies
  before_script:
    - docker-php-ext-install zip
  script:
    - ./vendor/bin/phpstan analyse --memory-limit=512M --error-format=gitlab > phpstan-report.json
  artifacts:
    reports:
      codequality: phpstan-report.json
    expire_in: 1 week
  allow_failure: false

test:unit:
  stage: test
  image: php:${PHP_VERSION}
  dependencies:
    - install:dependencies
  services:
    - postgres:16-alpine
  variables:
    POSTGRES_DB: laravel_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DB_HOST: postgres
    DB_CONNECTION: pgsql
    DB_DATABASE: laravel_test
    DB_USERNAME: postgres
    DB_PASSWORD: postgres
  before_script:
    - apt-get update && apt-get install -y libzip-dev libpng-dev libonig-dev libxml2-dev libpq-dev
    - docker-php-ext-install pdo_pgsql pgsql zip mbstring exif pcntl bcmath gd
    # Install PCOV for code coverage
    - pecl install pcov
    - docker-php-ext-enable pcov
    # Ensure reports directory exists
    - mkdir -p tests/reports
  script:
    - cp .env.testing .env || true
    - php artisan key:generate
    # Run tests with coverage
    - php artisan test --coverage --min=0
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    reports:
      junit: tests/reports/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: tests/reports/cobertura.xml
    expire_in: 1 week

build:production:
  stage: build
  image: php:${PHP_VERSION}
  dependencies:
    - install:dependencies
  before_script:
    - docker-php-ext-install zip
  script:
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-dev --optimize-autoloader
    - php artisan config:cache
    - php artisan route:cache
    - php artisan view:cache
  artifacts:
    paths:
      - vendor/
      - bootstrap/cache/
    expire_in: 1 week
  only:
    - master
    - main
    - production

